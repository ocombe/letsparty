/**
 * angular-localforage - Angular service & directive for https://github.com/mozilla/localForage (Offline storage, improved.)
 * @version v1.0.0
 * @link https://github.com/ocombe/angular-localForage
 * @license MIT
 * @author Olivier Combe <olivier.combe@gmail.com>
 */
!function(e,r,t){"use strict";var n=r.module("LocalForageModule",["ng"]);n.provider("$localForage",function(){var e={},n={name:"lf"},o={setItem:!1,removeItem:!1},i={};this.setNotify=function(e,r){o={setItem:e,removeItem:r}},this.config=function(e){if(!r.isObject(e))throw new Error("The config parameter should be an object");r.extend(n,e)},this.$get=["$rootScope","$q","$parse",function(a,s,f){var c=function(e){r.isDefined(e)?this._localforage=t.createInstance(e):(this._localforage=t,t.config(n))};c.prototype.createInstance=function(t){if(r.isObject(t)){if(t=r.extend({},n,t),r.isDefined(e[t.name]))throw new Error("A localForage instance with the name "+t.name+" is already defined.");return e[t.name]=new c(t),e[t.name]}throw new Error("The parameter should be a config object.")},c.prototype.instance=function(t){if(r.isUndefined(t))return e[n.name];if(r.isString(t)){if(r.isDefined(e[t]))return e[t];throw new Error("No localForage instance of that name exists.")}throw new Error("The parameter should be a string.")},c.prototype.setDriver=function(e){return this._localforage.setDriver(e)},c.prototype.driver=function(){return this._localforage.driver()},c.prototype.setItem=function(e,t){if(r.isUndefined(e))throw new Error("You must define a key to set");var n=s.defer(),i=arguments,f=r.copy(t),c=this;return r.isObject(f)&&r.isDefined(f.$promise)&&delete f.$promise,c._localforage.setItem(c.prefix()+e,f).then(function(){o.setItem&&a.$broadcast("LocalForageModule.setItem",{key:e,newvalue:f,driver:c.driver()}),n.resolve(f)},function(e){c.onError(e,i,c.setItem,n)}),n.promise},c.prototype.getItem=function(e){if(r.isUndefined(e))throw new Error("You must define a key to get");var t=s.defer(),n=arguments,o=this;return o._localforage.getItem(o.prefix()+e).then(function(e){t.resolve(e)},function(e){o.onError(e,n,o.getItem,t)}),t.promise},c.prototype.removeItem=function(e){if(r.isUndefined(e))throw new Error("You must define a key to remove");var t=s.defer(),n=arguments,i=this;return i._localforage.removeItem(i.prefix()+e).then(function(){t.resolve()},function(e){i.onError(e,n,i.removeItem,t)}),o.removeItem?t.promise.then(function(){a.$broadcast("LocalForageModule.removeItem",{key:e,driver:i.driver()})}):t.promise},c.prototype.clear=function(){var e=s.defer(),r=arguments,t=this;return t._localforage.clear().then(function(){e.resolve()},function(n){t.onError(n,r,t.clear,e)}),e.promise},c.prototype.key=function(e){if(r.isUndefined(e))throw new Error("You must define a position to get for the key function");var t=s.defer(),n=arguments,o=this;return o._localforage.key(e).then(function(e){t.resolve(e)},function(e){o.onError(e,n,o.key,t)}),t.promise};var u=function(){var e=s.defer(),r=arguments,t=this;return t._localforage.keys().then(function(r){if(n.oldPrefix&&"localStorageWrapper"===t.driver()){for(var o=[],i=0,a=r.length;a>i;i++)o.push(r[i].substr(t.prefix().length,r[i].length));r=o}e.resolve(r)},function(n){t.onError(n,r,t.keys,e)}),e.promise};return c.prototype.keys=u,c.prototype.getKeys=u,c.prototype.length=function(){var e=s.defer(),r=arguments,t=this;return t._localforage.length().then(function(r){e.resolve(r)},function(n){t.onError(n,r,length,e)}),e.promise},c.prototype.bind=function(t,o){if(r.isString(o))o={key:o};else if(!r.isObject(o)||r.isUndefined(o.key))throw new Error("You must define a key to bind");var a={defaultValue:"",name:n.name};o=r.extend({},a,o);var s=e[o.name];if(r.isUndefined(s))throw new Error("You must use the name of an existing instance");var c=o.scopeKey||o.key,u=f(c);return s.getItem(o.key).then(function(e){return e?u.assign(t,e):o.defaultValue&&(u.assign(t,o.defaultValue),s.setItem(o.key,o.defaultValue)),r.isDefined(i[o.key])&&i[o.key](),i[o.key]=t.$watch(c,function(e){r.isDefined(e)&&s.setItem(o.key,e)},!0),e})},c.prototype.unbind=function(t,o){if(r.isString(o))o={key:o};else if(!r.isObject(o)||r.isUndefined(o.key))throw new Error("You must define a key to unbind");var a={scopeKey:o.key,name:n.name};o=r.extend({},a,o);var s=e[o.name];if(r.isUndefined(s))throw new Error("You must use the name of an existing instance");return f(o.scopeKey).assign(t,null),r.isDefined(i[o.key])&&(i[o.key](),delete i[o.key]),s.removeItem(o.key)},c.prototype.prefix=function(){return"localStorageWrapper"===this.driver()&&n.oldPrefix?this._localforage.config().name+".":""},c.prototype.onError=function(e,t,n,o){if((r.isObject(e)&&e.name?"InvalidStateError"===e.name:r.isString(e)&&"InvalidStateError"===e)&&"asyncStorage"===this.driver()||r.isObject(e)&&e.code&&5===e.code){var i=this;i.setDriver("localStorageWrapper").then(function(){n.apply(i,t).then(function(e){o.resolve(e)},function(e){o.reject(e)})},function(){o.reject(e)})}else o.reject(e)},e[n.name]=new c,e[n.name]}]}),n.directive("localForage",["$localForage",function(e){return{restrict:"A",link:function(t,n,o){var i=t.$eval(o.localForage);r.isObject(i)&&r.isDefined(i.key)?e.bind(t,i):e.bind(t,o.localForage)}}}])}(window,window.angular,window.localforage);